var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,c=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,s=(e,t)=>{for(var r in t||(t={}))n.call(t,r)&&c(e,r,t[r]);if(o)for(var r of o(t))a.call(t,r)&&c(e,r,t[r]);return e};import{r as u,c as l,R as d,d as i,B as m,I as p,a as f}from"./vendor.97d80d38.js";function g(e){const t=u.exports.useRef(e);return t.current=e,u.exports.useCallback(((...e)=>t.current(...e)),[])}const v=e=>{const t=u.exports.useRef({}),{forceupdate:r}=function(){const[e,t]=u.exports.useState(0);return u.exports.useMemo((()=>({forceupdate:()=>t(e+1)})),[e])}();u.exports.useEffect((()=>{if(e.block.ajustPosition){const{top:o,left:n}=e.block,{height:a,width:c}=t.current.getBoundingClientRect();e.block.ajustPosition=!1,e.block.top=o-a/2,e.block.left=n-c/2,r()}}),[]);const o=u.exports.useMemo((()=>({top:`${e.block.top}px`,left:`${e.block.left}px`,opacity:e.block.ajustPosition?"0":""})),[e.block.top,e.block.left,e.block.ajustPosition]),n=u.exports.useMemo((()=>l(["visual-editor-block",{"visual-editor-block-focus":e.block.focus}])),[e.block.focus]),a=e.config.compMap[e.block.componentKey];let c;return a&&(c=a.render()),d.createElement("div",{className:n,style:o,ref:t,onMouseDown:e.onMousedown},c)};function b({top:e,left:t,comp:r}){return{componentKey:r.key,top:e,left:t,ajustPosition:!0,focus:!1}}const y={16:"shift",17:"ctrl",18:"alt",91:"command",8:"backspace",9:"tab",13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down",46:"delete",189:"-",187:"=",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12"};function k({value:e,focusData:t,updateBlocks:r,dragstart:o,dragend:n}){const a=function(){const[e]=u.exports.useState({current:-1,queue:[],commandArray:[],commands:{},destroyList:[]}),t=u.exports.useCallback((t=>{const r=u.exports.useRef(t);r.current=t,u.exports.useState((()=>{if(e.commands[t.name]){const r=e.commandArray.findIndex((e=>e.current.name===t.name));e.commandArray.splice(r,1)}e.commandArray.push(r),e.commands[t.name]=(...t)=>{const{redo:o,undo:n}=r.current.execute(...t);if(o(),!1===r.current.followQueue)return;let{queue:a,current:c}=e;a.length>0&&(a=a.slice(0,c+1),e.queue=a),a.push({undo:n,redo:o}),e.current=c+1}}))}),[]),[r]=u.exports.useState((()=>{const t=t=>{if(document.activeElement!==document.body)return;const{keyCode:r,shiftKey:o,altKey:n,ctrlKey:a,metaKey:c}=t;let s=[];(a||c)&&s.push("ctrl"),o&&s.push("shift"),n&&s.push("alt"),s.push(y[r]);const u=s.join("+");e.commandArray.forEach((({current:{keyboard:r,name:o}})=>{r&&(Array.isArray(r)?r:[r]).indexOf(u)>-1&&(t.stopPropagation(),t.preventDefault(),e.commands[o]())}))};return{init:()=>(window.addEventListener("keydown",t,!0),()=>{window.removeEventListener("keydown",t,!0)})}})),o=u.exports.useCallback((()=>{u.exports.useState((()=>{e.commandArray.forEach((t=>!!t.current.init&&e.destroyList.push(t.current.init()))),e.destroyList.push(r.init())})),t({name:"undo",keyboard:"ctrl+z",followQueue:!1,execute:()=>({redo:()=>{if(-1===e.current)return;const t=e.queue[e.current];t&&(t.undo&&t.undo(),e.current--)}})}),t({name:"redo",keyboard:["ctrl+y","ctrl+shift+z"],followQueue:!1,execute:()=>({redo:()=>{const t=e.queue[e.current+1];t&&(t.redo(),e.current++)}})})}),[]);return u.exports.useEffect((()=>()=>{e.destroyList.forEach((e=>!!e&&e()))}),[]),{useRegistry:t,useInit:o,state:e}}();return a.useRegistry({name:"delete",keyboard:["backspace","delete","ctrl+d","command+d"],execute(){console.log("执行删除命令");let o={before:i(e.blocks),after:i(t.unfocus)};return{redo:()=>{r(i(o.after))},undo:()=>{r(i(o.before))}}}}),a.useRegistry({name:"selectAll",followQueue:!1,keyboard:["command+a","ctrl+a"],execute:()=>(console.log("执行全选命令"),{redo:()=>{e.blocks.forEach((e=>e.focus=!0)),r(e.blocks)}})}),(()=>{const t=u.exports.useRef({before:null}),c={dragstart:g((()=>t.current.before=i(e.blocks))),dragend:g((()=>a.state.commands.drag()))};a.useRegistry({name:"drag",init:()=>(t.current={before:null},o.on(c.dragstart),n.on(c.dragend),()=>{o.off(c.dragstart),n.off(c.dragend)}),execute(){let o=i(t.current.before),n=i(e.blocks);return{redo:()=>{r(i(n))},undo:()=>{r(i(o))}}}})})(),a.useInit(),{delete:()=>a.state.commands.delete(),undo:()=>a.state.commands.undo(),redo:()=>a.state.commands.redo()}}function h(){let e=[];return{on:t=>{e.push(t)},off:t=>{const r=e.indexOf(t);r>-1&&e.splice(r,1)},emit:()=>{e.forEach((e=>e()))}}}const E=e=>{const[o,n]=u.exports.useState(!1),[a,c]=u.exports.useState(!1),[l]=u.exports.useState((()=>h())),[i]=u.exports.useState((()=>h())),m=u.exports.useRef({}),p=u.exports.useMemo((()=>({width:`${e.value.container.width}px`,height:`${e.value.container.height}px`})),[e.value.container.height,e.value.container.width]),f=u.exports.useMemo((()=>{const t=[],r=[];return e.value.blocks.forEach((e=>{(e.focus?t:r).push(e)})),{focus:t,unfocus:r}}),[e.value.blocks]),y={updateBlocks:o=>{var n,a;e.onChange((n=s({},e.value),a={blocks:[...o]},t(n,r(a))))},clearFocus:t=>{(t?f.focus.filter((e=>e!==t)):f.focus).forEach((e=>{e.focus=!1})),y.updateBlocks(e.value.blocks)}},E=(()=>{const t=u.exports.useRef({dragComp:null}),r={dragstart:g(((e,r)=>{m.current.addEventListener("dragenter",o.dragenter),m.current.addEventListener("dragover",o.dragover),m.current.addEventListener("dragleave",o.dragleave),m.current.addEventListener("drop",o.drop),t.current.dragComp=r,l.emit()})),dragend:g((e=>{m.current.removeEventListener("dragenter",o.dragenter),m.current.removeEventListener("dragover",o.dragover),m.current.removeEventListener("dragleave",o.dragleave),m.current.removeEventListener("drop",o.drop)}))},o={dragenter:g((e=>{e.dataTransfer.dropEffect="move"})),dragover:g((e=>{e.preventDefault()})),dragleave:g((e=>{e.dataTransfer.dropEffect="none"})),drop:g((r=>{console.log("!!!","add new block"),y.updateBlocks([...e.value.blocks,b({top:r.offsetY,left:r.offsetX,comp:t.current.dragComp})]),setTimeout((()=>{i.emit()}))}))};return r})(),x={block:(e,t)=>{e.shiftKey?(console.log("press shift"),f.focus.length<=1?t.focus=!0:t.focus=!t.focus):t.focus||(t.focus=!0,y.clearFocus(t)),setTimeout((()=>{w.mousedown(e)}))},container:e=>{e.target===e.currentTarget&&(e.shiftKey||y.clearFocus())}},w=(()=>{const t=u.exports.useRef({startX:0,startY:0,startPosArray:[],dragging:!1}),r=g((e=>{document.addEventListener("mousemove",o),document.addEventListener("mouseup",n),t.current={startX:e.clientX,startY:e.clientY,startPosArray:f.focus.map((({top:e,left:t})=>({top:e,left:t}))),dragging:!1}})),o=g((r=>{const{startX:o,startY:n,startPosArray:a}=t.current,{clientX:c,clientY:s}=r,u=c-o,d=s-n;f.focus.forEach(((e,t)=>{const{left:r,top:o}=a[t];e.left=r+u,e.top=o+d})),y.updateBlocks(e.value.blocks),t.current.dragging||(t.current.dragging=!0,l.emit())})),n=g((e=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n),t.current.dragging&&i.emit()}));return{mousedown:r}})(),L=k({value:e.value,focusData:f,updateBlocks:y.updateBlocks,dragstart:l,dragend:i}),F=[{label:"撤销",icon:"icon-back",handler:()=>L.undo(),tip:"ctrl+z"},{label:"重做",icon:"icon-forward",handler:()=>L.redo(),tip:"ctrl+y, ctrl+shift+z"},{label:()=>o?"编辑":"预览",icon:()=>o?"icon-edit":"icon-browse",handler:()=>{o||y.clearFocus(),n(!o)}},{label:"导入",icon:"icon-import",handler:async()=>{}},{label:"导出",icon:"icon-export",handler:()=>{}},{label:"删除",icon:"icon-delete",handler:()=>L.delete(),tip:"ctrl+d, backspace, delete"},{label:"清空",icon:"icon-reset",handler:()=>{}},{label:"关闭",icon:"icon-close",handler:()=>{y.clearFocus(),c(!1)}}];return d.createElement("div",{className:"visual-editor"},d.createElement("div",{className:"visual-editor-menu"},e.config.compArray.map((e=>d.createElement("div",{key:e.key,className:"visual-editor-menu-item",draggable:!0,onDragStart:t=>E.dragstart(t,e),onDragEnd:E.dragend},e.preview(),d.createElement("div",{className:"visual-editor-menu-item-name"},e.name))))),d.createElement("div",{className:"visual-editor-head"},F.map(((e,t)=>{const r="function"==typeof e.label?e.label():e.label,o="function"==typeof e.icon?e.icon():e.icon;return d.createElement("div",{className:"visual-editor-head-btn",key:`${t}_BTN`,onClick:e.handler},d.createElement("i",{className:`iconfont ${o}`}),d.createElement("span",null,r))}))),d.createElement("div",{className:"visual-editor-operator"}),d.createElement("div",{className:"visual-editor-body"},d.createElement("div",{className:"visual-editor-container",style:p,ref:m,onMouseDown:x.container},e.value.blocks.map(((t,r)=>d.createElement(v,{key:r,block:t,config:e.config,onMousedown:e=>x.block(e,t)}))))))},x=function(){const e={},t=[];return{registryComp:function(r,o){if(e[r]){const o=t.indexOf(e[r]);t.splice(o,1)}const n=s({key:r},o);t.push(n),e[r]=n},compMap:e,compArray:t}}();x.registryComp("text",{name:"文本",preview:()=>d.createElement("span",null,"预览文本"),render:()=>d.createElement("span",null,"渲染文本")}),x.registryComp("button",{name:"按钮",preview:()=>d.createElement(m,{type:"primary"},"预览按钮"),render:()=>d.createElement(m,{type:"primary"},"渲染按钮")}),x.registryComp("input",{name:"输入框",preview:()=>d.createElement(p,null),render:()=>d.createElement(p,null)});var w=()=>{const[e,t]=u.exports.useState((()=>({container:{height:500,width:800},blocks:[{componentKey:"text",top:100,left:100,ajustPosition:!1,focus:!1},{componentKey:"button",top:200,left:200,ajustPosition:!1,focus:!1}]})));return d.createElement("div",{className:"app-home"},d.createElement(E,{config:x,value:e,onChange:t}))};f.render(d.createElement(w,null),document.getElementById("app"));
