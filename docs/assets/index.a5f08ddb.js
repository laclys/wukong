var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,c=(t,o,r)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[o]=r,s=(e,t)=>{for(var o in t||(t={}))n.call(t,o)&&c(e,o,t[o]);if(r)for(var o of r(t))a.call(t,o)&&c(e,o,t[o]);return e},l=(e,r)=>t(e,o(r));import{r as i,c as u,R as d,B as p,I as m,a as f}from"./vendor.8654c592.js";function v(e){const t=i.exports.useRef(e);return t.current=e,i.exports.useCallback(((...e)=>t.current(...e)),[])}const b=e=>{const t=i.exports.useRef({}),{forceupdate:o}=function(){const[e,t]=i.exports.useState(0);return i.exports.useMemo((()=>({forceupdate:()=>t(e+1)})),[e])}();i.exports.useEffect((()=>{if(e.block.ajustPosition){const{top:r,left:n}=e.block,{height:a,width:c}=t.current.getBoundingClientRect();e.block.ajustPosition=!1,e.block.top=r-a/2,e.block.left=n-c/2,o()}}),[]);const r=i.exports.useMemo((()=>({top:`${e.block.top}px`,left:`${e.block.left}px`,opacity:e.block.ajustPosition?"0":""})),[e.block.top,e.block.left,e.block.ajustPosition]),n=i.exports.useMemo((()=>u(["visual-editor-block",{"visual-editor-block-focus":e.block.focus}])),[e.block.focus]),a=e.config.compMap[e.block.componentKey];let c;return a&&(c=a.render()),d.createElement("div",{className:n,style:r,ref:t,onMouseDown:e.onMousedown},c)};function g({top:e,left:t,comp:o}){return{componentKey:o.key,top:e,left:t,ajustPosition:!0,focus:!1}}const E=e=>{const[t,o]=i.exports.useState(!1),[r,n]=i.exports.useState(!1),a=i.exports.useRef({}),c=i.exports.useMemo((()=>({width:`${e.value.container.width}px`,height:`${e.value.container.height}px`})),[e.value.container.height,e.value.container.width]),u=i.exports.useMemo((()=>{const t=[],o=[];return e.value.blocks.forEach((e=>{(e.focus?t:o).push(e)})),{focus:t,unfocus:o}}),[e.value.blocks]),p={updateBlocks:t=>{e.onChange(l(s({},e.value),{blocks:[...t]}))},clearFocus:t=>{(t?u.focus.filter((e=>e!==t)):u.focus).forEach((e=>{e.focus=!1})),p.updateBlocks(e.value.blocks)}},m=(()=>{const t=i.exports.useRef({dragComp:null}),o={dragstart:v(((e,o)=>{a.current.addEventListener("dragenter",r.dragenter),a.current.addEventListener("dragover",r.dragover),a.current.addEventListener("dragleave",r.dragleave),a.current.addEventListener("drop",r.drop),t.current.dragComp=o})),dragend:v((e=>{a.current.removeEventListener("dragenter",r.dragenter),a.current.removeEventListener("dragover",r.dragover),a.current.removeEventListener("dragleave",r.dragleave),a.current.removeEventListener("drop",r.drop)}))},r={dragenter:v((e=>{e.dataTransfer.dropEffect="move"})),dragover:v((e=>{e.preventDefault()})),dragleave:v((e=>{e.dataTransfer.dropEffect="none"})),drop:v((o=>{console.log("!!!","add new block"),e.onChange(l(s({},e.value),{blocks:[...e.value.blocks,g({top:o.offsetY,left:o.offsetX,comp:t.current.dragComp})]}))}))};return o})(),f={block:(e,t)=>{e.shiftKey?(console.log("press shift"),u.focus.length<=1?t.focus=!0:t.focus=!t.focus):t.focus||(t.focus=!0,p.clearFocus(t)),setTimeout((()=>{E.mousedown(e)}))},container:e=>{e.target===e.currentTarget&&(e.shiftKey||p.clearFocus())}},E=(()=>{const t=i.exports.useRef({startX:0,startY:0,startPosArray:[]}),o=v((e=>{document.addEventListener("mousemove",r),document.addEventListener("mouseup",n),t.current={startX:e.clientX,startY:e.clientY,startPosArray:u.focus.map((({top:e,left:t})=>({top:e,left:t})))}})),r=v((o=>{const{startX:r,startY:n,startPosArray:a}=t.current,{clientX:c,clientY:s}=o,l=c-r,i=s-n;u.focus.forEach(((e,t)=>{const{left:o,top:r}=a[t];e.left=o+l,e.top=r+i})),p.updateBlocks(e.value.blocks)})),n=v((e=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)}));return{mousedown:o}})(),y=[{label:"撤销",icon:"icon-back",handler:()=>{},tip:"ctrl+z"},{label:"重做",icon:"icon-forward",handler:()=>{},tip:"ctrl+y, ctrl+shift+z"},{label:()=>t?"编辑":"预览",icon:()=>t?"icon-edit":"icon-browse",handler:()=>{t||p.clearFocus(),o(!t)}},{label:"导入",icon:"icon-import",handler:async()=>{}},{label:"导出",icon:"icon-export",handler:()=>{}},{label:"删除",icon:"icon-delete",handler:()=>{},tip:"ctrl+d, backspace, delete"},{label:"清空",icon:"icon-reset",handler:()=>{}},{label:"关闭",icon:"icon-close",handler:()=>{p.clearFocus(),n(!1)}}];return d.createElement("div",{className:"visual-editor"},d.createElement("div",{className:"visual-editor-menu"},e.config.compArray.map((e=>d.createElement("div",{key:e.key,className:"visual-editor-menu-item",draggable:!0,onDragStart:t=>m.dragstart(t,e),onDragEnd:m.dragend},e.preview(),d.createElement("div",{className:"visual-editor-menu-item-name"},e.name))))),d.createElement("div",{className:"visual-editor-head"},y.map(((e,t)=>{const o="function"==typeof e.label?e.label():e.label,r="function"==typeof e.icon?e.icon():e.icon;return d.createElement("div",{className:"visual-editor-head-btn",key:`${t}_BTN`},d.createElement("i",{className:`iconfont ${r}`}),d.createElement("span",null,o))}))),d.createElement("div",{className:"visual-editor-operator"}),d.createElement("div",{className:"visual-editor-body"},d.createElement("div",{className:"visual-editor-container",style:c,ref:a,onMouseDown:f.container},e.value.blocks.map(((t,o)=>d.createElement(b,{key:o,block:t,config:e.config,onMousedown:e=>f.block(e,t)}))))))},y=function(){const e={},t=[];return{registryComp:function(o,r){if(e[o]){const r=t.indexOf(e[o]);t.splice(r,1)}const n=s({key:o},r);t.push(n),e[o]=n},compMap:e,compArray:t}}();y.registryComp("text",{name:"文本",preview:()=>d.createElement("span",null,"预览文本"),render:()=>d.createElement("span",null,"渲染文本")}),y.registryComp("button",{name:"按钮",preview:()=>d.createElement(p,{type:"primary"},"预览按钮"),render:()=>d.createElement(p,{type:"primary"},"渲染按钮")}),y.registryComp("input",{name:"输入框",preview:()=>d.createElement(m,null),render:()=>d.createElement(m,null)});var k=()=>{const[e,t]=i.exports.useState((()=>({container:{height:500,width:800},blocks:[{componentKey:"text",top:100,left:100,ajustPosition:!1,focus:!1},{componentKey:"button",top:200,left:200,ajustPosition:!1,focus:!1}]})));return d.createElement("div",{className:"app-home"},d.createElement(E,{config:y,value:e,onChange:t}))};f.render(d.createElement(k,null),document.getElementById("app"));
